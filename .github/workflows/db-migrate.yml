name: Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - production
          - staging
        default: staging
      migration_type:
        description: "Migration type"
        required: true
        type: choice
        options:
          - push
          - migrate
        default: push
      dry_run:
        description: "Dry run (show changes without applying)"
        required: false
        type: boolean
        default: false

jobs:
  migrate:
    name: Run Database Migration
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: ~/.bun/install/cache
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lock') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run Migration (Dry Run)
        if: ${{ github.event.inputs.dry_run == 'true' }}
        working-directory: packages/db
        run: |
          echo "ðŸ” Dry run mode - showing pending changes..."
          if [ "${{ github.event.inputs.migration_type }}" = "push" ]; then
            bunx drizzle-kit push --dry-run
          else
            bunx drizzle-kit migrate --dry-run
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Run Migration
        if: ${{ github.event.inputs.dry_run == 'false' }}
        working-directory: packages/db
        run: |
          echo "ðŸš€ Running database migration (${{ github.event.inputs.migration_type }})..."
          if [ "${{ github.event.inputs.migration_type }}" = "push" ]; then
            bunx drizzle-kit push
          else
            bunx drizzle-kit migrate
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}

      - name: Migration Summary
        run: |
          echo "## Migration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Migration Type:** ${{ github.event.inputs.migration_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ github.event.inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
